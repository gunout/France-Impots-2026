<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IRCOM - Dashboard La R√©union</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- SheetJS -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
    
    <style>
        body { background: #f8f9fa; }
        .glass-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 25px;
            margin: 20px 0;
        }
        .kpi-card {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin: 10px 0;
        }
        .kpi-value { font-size: 32px; font-weight: bold; }
        .upload-area {
            border: 3px dashed #4a90e2;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: rgba(255,255,255,0.9);
            cursor: pointer;
        }
        .commune-item {
            cursor: pointer;
            padding: 15px;
            margin: 5px 0;
            border-radius: 10px;
            background: white;
            border: 1px solid #dee2e6;
            transition: all 0.3s;
        }
        .commune-item:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .commune-item.active {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
        }
        .text-danger { color: #dc3545 !important; }
    </style>
</head>
<body>

<div class="container py-4">
    <!-- En-t√™te -->
    <div class="glass-card text-center">
        <h1 class="display-4">üèùÔ∏è IRCOM - La R√©union</h1>
        <p class="lead">Donn√©es officielles DGFiP ‚Ä¢ Revenus 2023</p>
        <p class="text-muted">Montants en milliers d'euros</p>
    </div>

    <!-- Zone d'upload -->
    <div class="glass-card">
        <div class="upload-area" onclick="document.getElementById('fileInput').click()">
            <input type="file" id="fileInput" accept=".xls,.xlsx" style="display: none;">
            <h3>üìÇ T√©l√©chargez votre fichier 974.xls</h3>
            <p class="text-muted">Cliquez ou glissez-d√©posez votre fichier Excel</p>
        </div>
        <div id="status" class="alert alert-info mt-3">
            En attente du fichier La R√©union...
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" style="display: none;">
        <div class="row mt-4">
            <!-- Liste des communes -->
            <div class="col-md-4">
                <div class="glass-card">
                    <h4>üèòÔ∏è Communes</h4>
                    <div id="communeCount" class="badge bg-success mb-3"></div>
                    <div id="communeList" style="max-height: 600px; overflow-y: auto;"></div>
                </div>
            </div>
            
            <!-- D√©tails -->
            <div class="col-md-8">
                <div id="details" class="glass-card">
                    <div class="alert alert-info">
                        S√©lectionnez une commune pour voir les d√©tails
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ============================================================
// CONSTANTES - 24 COMMUNES DE LA R√âUNION
// ============================================================
const COMMUNES_974 = [
    { code: "401", nom: "Les Avirons" },
    { code: "402", nom: "Bras-Panon" },
    { code: "403", nom: "Entre-Deux" },
    { code: "404", nom: "L'√âtang-Sal√©" },
    { code: "405", nom: "Petite-√éle" },
    { code: "406", nom: "La Plaine-des-Palmistes" },
    { code: "407", nom: "Le Port" },
    { code: "408", nom: "La Possession" },
    { code: "409", nom: "Saint-Andr√©" },
    { code: "410", nom: "Saint-Beno√Æt" },
    { code: "411", nom: "Saint-Denis" },
    { code: "412", nom: "Saint-Joseph" },
    { code: "413", nom: "Saint-Leu" },
    { code: "414", nom: "Saint-Louis" },
    { code: "415", nom: "Saint-Paul" },
    { code: "416", nom: "Saint-Pierre" },
    { code: "417", nom: "Saint-Philippe" },
    { code: "418", nom: "Sainte-Marie" },
    { code: "419", nom: "Sainte-Rose" },
    { code: "420", nom: "Sainte-Suzanne" },
    { code: "421", nom: "Salazie" },
    { code: "422", nom: "Le Tampon" },
    { code: "423", nom: "Les Trois-Bassins" },
    { code: "424", nom: "Cilaos" }
];

// ============================================================
// FONCTION DE LECTURE SP√âCIFIQUE POUR LE FICHIER R√âUNION
// ============================================================
document.getElementById('fileInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const status = document.getElementById('status');
    status.className = 'alert alert-warning';
    status.innerHTML = 'üîÑ Lecture du fichier...';
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            // üî• Lire le fichier avec SheetJS
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { 
                type: 'array',
                cellText: true,
                cellDates: false,
                sheetStubs: true,
                raw: true,
                codepage: 1252,
                cellFormula: false,
                cellHTML: false,
                sheetRows: 1000 // Lire seulement les 1000 premi√®res lignes
            });
            
            // Prendre la premi√®re feuille
            const firstSheet = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheet];
            
            // üî• Conversion en JSON brut sans en-t√™tes
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { 
                header: 1,
                defval: '',
                blankrows: false,
                raw: true
            });
            
            // üî• ANALYSE SP√âCIFIQUE POUR LE FORMAT R√âUNION
            const communes = parseReunionFile(jsonData);
            
            if (Object.keys(communes).length === 0) {
                throw new Error("Aucune commune trouv√©e");
            }
            
            // ‚úÖ SUCC√àS !
            status.className = 'alert alert-success';
            status.innerHTML = `‚úÖ ${Object.keys(communes).length} communes de La R√©union charg√©es !`;
            
            // Afficher le dashboard
            document.getElementById('dashboard').style.display = 'block';
            displayCommunes(communes);
            
        } catch(error) {
            console.error(error);
            status.className = 'alert alert-danger';
            status.innerHTML = `
                ‚ùå Erreur: ${error.message}<br>
                <small>V√©rifiez que le fichier est bien le IRCOM 974</small>
                <button class="btn btn-sm btn-warning mt-2" onclick="loadDemoData()">
                    üìä Charger les donn√©es de d√©monstration
                </button>
            `;
        }
    };
    reader.readAsArrayBuffer(file);
});

// ============================================================
// ANALYSE SP√âCIFIQUE POUR LE FICHIER R√âUNION
// ============================================================
function parseReunionFile(rows) {
    const communes = {};
    let currentCommune = null;
    
    // Parcourir toutes les lignes
    for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        if (!row || row.length < 5) continue;
        
        // Nettoyer les valeurs
        const col0 = String(row[0] || '').trim();
        const col1 = String(row[1] || '').trim();
        const col2 = String(row[2] || '').trim();
        const col3 = String(row[3] || '').trim();
        
        // üî• D√âTECTION D'UNE COMMUNE
        // Format: 974 | 401 | Les Avirons | 0 √† 10 000 | ...
        if (col0 === '974' && col1.length === 3 && !isNaN(col1) && col2 && 
            !col2.includes('LA REUNION') && !col2.includes('D√©p.') && !col2.includes('Libell√©')) {
            
            const nomCommune = col2;
            const codeCommune = col1;
            const tranche = col3;
            
            // Initialiser la commune
            if (!communes[nomCommune]) {
                communes[nomCommune] = {
                    nom: nomCommune,
                    code: codeCommune,
                    insee: `974${codeCommune}`,
                    tranches: [],
                    total_foyers: 0,
                    total_revenu: 0,
                    total_impot: 0,
                    total_foyers_imposes: 0
                };
            }
            
            // üî• LECTURE DES VALEURS
            if (tranche && tranche !== 'Total' && !tranche.includes('Revenu')) {
                // Nettoyer et convertir les nombres
                const foyers = parseFloat(String(row[4] || '0').replace(/,/g, '.').replace(/[^\d.-]/g, '')) || 0;
                const revenu = parseFloat(String(row[5] || '0').replace(/,/g, '.').replace(/[^\d.-]/g, '')) || 0;
                const impot = parseFloat(String(row[6] || '0').replace(/,/g, '.').replace(/[^\d.-]/g, '')) || 0;
                const foyersImposes = parseFloat(String(row[7] || '0').replace(/,/g, '.').replace(/[^\d.-]/g, '')) || 0;
                
                communes[nomCommune].tranches.push({
                    nom: tranche,
                    foyers: foyers,
                    revenu: revenu,
                    impot: impot,
                    foyers_imposes: foyersImposes
                });
            }
            
            // üî• LECTURE DE LA LIGNE TOTAL
            if (tranche === 'Total') {
                communes[nomCommune].total_foyers = parseFloat(String(row[4] || '0').replace(/,/g, '.').replace(/[^\d.-]/g, '')) || 0;
                communes[nomCommune].total_revenu = parseFloat(String(row[5] || '0').replace(/,/g, '.').replace(/[^\d.-]/g, '')) || 0;
                communes[nomCommune].total_impot = parseFloat(String(row[6] || '0').replace(/,/g, '.').replace(/[^\d.-]/g, '')) || 0;
                communes[nomCommune].total_foyers_imposes = parseFloat(String(row[7] || '0').replace(/,/g, '.').replace(/[^\d.-]/g, '')) || 0;
                
                // üìà CALCULS
                const data = communes[nomCommune];
                if (data.total_foyers > 0) {
                    data.revenu_moyen = Math.round((data.total_revenu * 1000) / data.total_foyers);
                }
                if (data.total_foyers_imposes > 0) {
                    data.impot_moyen = Math.round((data.total_impot * 1000) / data.total_foyers_imposes);
                }
                if (data.total_foyers > 0) {
                    data.taux_imposition = ((data.total_foyers_imposes / data.total_foyers) * 100).toFixed(1);
                }
            }
        }
    }
    
    return communes;
}

// ============================================================
// AFFICHAGE DES COMMUNES
// ============================================================
function displayCommunes(communes) {
    const container = document.getElementById('communeList');
    const count = document.getElementById('communeCount');
    
    const communeNames = Object.keys(communes).sort();
    count.innerHTML = `${communeNames.length} communes trouv√©es`;
    
    container.innerHTML = '';
    
    communeNames.forEach((nom, index) => {
        const data = communes[nom];
        
        const item = document.createElement('div');
        item.className = 'commune-item';
        item.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="mb-1">${nom}</h6>
                    <small>Code: ${data.code}</small>
                </div>
                <div class="text-end">
                    <span class="badge bg-primary">${data.total_foyers.toLocaleString()}</span>
                    <br>
                    <small>foyers</small>
                </div>
            </div>
            <div class="mt-2">
                <div class="d-flex justify-content-between">
                    <small>üí∞ ${data.revenu_moyen?.toLocaleString() || 'N/A'} ‚Ç¨</small>
                    <small>üìä ${data.taux_imposition || 0}%</small>
                </div>
            </div>
        `;
        
        item.onclick = function() {
            // Enlever la classe active de tous les items
            document.querySelectorAll('.commune-item').forEach(el => {
                el.classList.remove('active');
            });
            this.classList.add('active');
            
            // Afficher les d√©tails
            displayCommuneDetails(communes, nom);
        };
        
        container.appendChild(item);
    });
    
    // S√©lectionner la premi√®re commune
    if (communeNames.length > 0) {
        document.querySelector('.commune-item').classList.add('active');
        displayCommuneDetails(communes, communeNames[0]);
    }
}

// ============================================================
// AFFICHAGE DES D√âTAILS D'UNE COMMUNE
// ============================================================
function displayCommuneDetails(communes, nom) {
    const data = communes[nom];
    const container = document.getElementById('details');
    
    let html = `
        <div class="d-flex justify-content-between align-items-start">
            <h4>üèõÔ∏è ${nom}</h4>
            <span class="badge bg-secondary">INSEE: 974${data.code}</span>
        </div>
        
        <div class="row mt-4">
            <div class="col-md-3">
                <div class="kpi-card">
                    <div class="kpi-title">Revenu moyen</div>
                    <div class="kpi-value">${data.revenu_moyen?.toLocaleString() || 0} ‚Ç¨</div>
                    <small>par foyer</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kpi-card">
                    <div class="kpi-title">Imp√¥t moyen</div>
                    <div class="kpi-value">${data.impot_moyen?.toLocaleString() || 0} ‚Ç¨</div>
                    <small>par foyer impos√©</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kpi-card">
                    <div class="kpi-title">Foyers</div>
                    <div class="kpi-value">${data.total_foyers.toLocaleString()}</div>
                    <small>dont ${data.total_foyers_imposes.toLocaleString()} impos√©s</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kpi-card">
                    <div class="kpi-title">Taux</div>
                    <div class="kpi-value">${data.taux_imposition || 0}%</div>
                    <small>d'imposition</small>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h6>Revenu total</h6>
                        <h3 class="text-primary">${(data.total_revenu * 1000).toLocaleString()} ‚Ç¨</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h6>Imp√¥t total</h6>
                        <h3 class="${data.total_impot < 0 ? 'text-danger' : 'text-success'}">
                            ${(data.total_impot * 1000).toLocaleString()} ‚Ç¨
                        </h3>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-4">
            <h6>üìä D√©tail par tranche de revenu</h6>
            <div style="max-height: 400px; overflow-y: auto;">
                <table class="table table-sm table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Tranche</th>
                            <th class="text-end">Foyers</th>
                            <th class="text-end">Revenu (k‚Ç¨)</th>
                            <th class="text-end">Imp√¥t (k‚Ç¨)</th>
                            <th class="text-end">Foyers impos√©s</th>
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    // Trier les tranches
    const order = ['0 √† 10 000', '10 001 √† 12 000', '12 001 √† 15 000', '15 001 √† 20 000', 
                   '20 001 √† 30 000', '30 001 √† 50 000', '50 001 √† 100 000', '+ de 100 000'];
    
    data.tranches.sort((a, b) => order.indexOf(a.nom) - order.indexOf(b.nom));
    
    data.tranches.forEach(tranche => {
        html += `
            <tr>
                <td>${tranche.nom}</td>
                <td class="text-end">${Math.round(tranche.foyers).toLocaleString()}</td>
                <td class="text-end">${tranche.revenu.toLocaleString()} k‚Ç¨</td>
                <td class="text-end ${tranche.impot < 0 ? 'text-danger' : ''}">
                    ${tranche.impot.toLocaleString()} k‚Ç¨
                </td>
                <td class="text-end">${tranche.foyers_imposes > 0 ? Math.round(tranche.foyers_imposes).toLocaleString() : 'n.c.'}</td>
            </tr>
        `;
    });
    
    html += `
                    </tbody>
                    <tfoot class="table-secondary">
                        <tr>
                            <th>TOTAL</th>
                            <th class="text-end">${data.total_foyers.toLocaleString()}</th>
                            <th class="text-end">${data.total_revenu.toLocaleString()} k‚Ç¨</th>
                            <th class="text-end ${data.total_impot < 0 ? 'text-danger' : ''}">
                                ${data.total_impot.toLocaleString()} k‚Ç¨
                            </th>
                            <th class="text-end">${data.total_foyers_imposes.toLocaleString()}</th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
}

// ============================================================
// DONN√âES DE D√âMONSTRATION (SI LE FICHIER NE MARCHE PAS)
// ============================================================
function loadDemoData() {
    const communes = {};
    
    // Cr√©er des donn√©es r√©alistes pour les 24 communes
    COMMUNES_974.forEach((commune, index) => {
        const baseFoyers = 5000 + (index * 300);
        const baseRevenu = 150000 + (index * 5000);
        const baseImpot = 5000 + (index * 200);
        
        communes[commune.nom] = {
            nom: commune.nom,
            code: commune.code,
            insee: `974${commune.code}`,
            total_foyers: baseFoyers,
            total_revenu: baseRevenu,
            total_impot: baseImpot,
            total_foyers_imposes: Math.round(baseFoyers * 0.35),
            revenu_moyen: Math.round((baseRevenu * 1000) / baseFoyers),
            impot_moyen: Math.round((baseImpot * 1000) / Math.round(baseFoyers * 0.35)),
            taux_imposition: '35.0',
            tranches: []
        };
    });
    
    const status = document.getElementById('status');
    status.className = 'alert alert-success';
    status.innerHTML = '‚úÖ Donn√©es de d√©monstration charg√©es (24 communes)';
    
    document.getElementById('dashboard').style.display = 'block';
    displayCommunes(communes);
}
</script>

</body>
</html>
